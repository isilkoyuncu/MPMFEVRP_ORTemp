using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using MPMFEVRP.Domains.ProblemDomain;
using MPMFEVRP.Domains.SolutionDomain;
using MPMFEVRP.Models.CustomerSetSolvers.Interfaces_and_Bases;
using MPMFEVRP.Implementations.ProblemModels.Interfaces_and_Bases;
using MPMFEVRP.Domains.AlgorithmDomain;
using System.Diagnostics;
using MPMFEVRP.Utils;

namespace MPMFEVRP.Models.CustomerSetSolvers
{
    /// <summary>
    /// This class implements the flow chart in the second paper. AFV solver exploits the GDV optimal routes to speed up the process.
    /// </summary>
    public class CustomerSetSolver_Homogeneous_ExploitingVirtualGDVs : ICustomerSetSolver
    {
        readonly EVvsGDV_ProblemModel theProblemModel;
        readonly Vehicle theAFV;
        readonly Vehicle theGDV;
        public readonly CustomerSetSolverWithOnlyAFV AFV_Solver;
        public readonly CustomerSetSolverWithOnlyGDV GDV_Solver;
        //readonly CustomerSetSolverWithOnlyAFV AFV_SolutionChecker;
        Stopwatch stopwatch = new Stopwatch();
        double t0GDVSoln = 0.0; //public double T0GDVSoln => t0GDVSoln;
        double t1CheckAFVfeas = 0.0; //public double T1CheckAFVfeas => t1CheckAFVfeas;
        double t2CheckAFVinfeas = 0.0; //public double T2CheckAFVinfeas => t2CheckAFVinfeas;
        double t3RefuelingPathInsert = 0.0; //public double T3RefuelingPathInsert => t3RefuelingPathInsert;
        double t4SwapAndInsert = 0.0; //public double T4SwapAndInsert => t4SwapAndInsert;
        double t5AFVSoln = 0.0; //public double T5AFVSoln => t5AFVSoln;

        double vmt3RefuelingPathInsert = 0.0;
        double vmt4SwapAndInsert = 0.0;
        double vmt5AFVSoln = 0.0;
        List<string> bestRoute = new List<string>();

        int idealStopAfter = 5;

        public OptimizationStatistics optimizationStatstics;

        public CustomerSetSolver_Homogeneous_ExploitingVirtualGDVs(EVvsGDV_ProblemModel theProblemModel)
        {
            this.theProblemModel = theProblemModel;
            theAFV = theProblemModel.VRD.GetTheVehicleOfCategory(VehicleCategories.EV);
            theGDV = theProblemModel.VRD.GetTheVehicleOfCategory(VehicleCategories.GDV);

            AFV_Solver = new CustomerSetSolverWithOnlyAFV(theProblemModel);
            GDV_Solver = new CustomerSetSolverWithOnlyGDV(theProblemModel);
        }
        public RouteOptimizationOutcome Solve(CustomerSet customerSet, Exploiting_GDVs_Flowchart flowchart, bool PreserveCustomerVisitSequence, bool feasibleAFVSolnIsEnough, bool performSwap)
        {
            t0GDVSoln = 0.0;
            t1CheckAFVfeas = 0.0;
            t2CheckAFVinfeas = 0.0;
            t3RefuelingPathInsert = 0.0;
            t4SwapAndInsert = 0.0;
            t5AFVSoln = 0.0;

            vmt3RefuelingPathInsert = 0.0;
            vmt4SwapAndInsert = 0.0;
            vmt5AFVSoln = 0.0;

            switch (flowchart)
            {
                case Exploiting_GDVs_Flowchart.a_NoExploiting:
                    return SolveNoExploitingGDVs(customerSet);
                case Exploiting_GDVs_Flowchart.b_OnlyIdenticalRoutes:
                    return SolveOnlyIdenticalRoutes(customerSet);
                case Exploiting_GDVs_Flowchart.c_PathInsertedRoutes:
                    return SolveRefuelingPathInsertedRoutes(customerSet);
                case Exploiting_GDVs_Flowchart.d_PathInsertedAndSwappedRoutes:
                    return SolveRefuelingPathInsertedAndSwappedRoutes(customerSet);
                default:
                    return SolveDataCollection(customerSet, PreserveCustomerVisitSequence, feasibleAFVSolnIsEnough, performSwap);
            }
        }

        RouteOptimizationOutcome GetROO(VehicleSpecificRouteOptimizationOutcome vsroo_GDV, VehicleSpecificRouteOptimizationOutcome vsroo_AFV)
        {
            if (vsroo_GDV.Status == VehicleSpecificRouteOptimizationStatus.Infeasible)
                return new RouteOptimizationOutcome(RouteOptimizationStatus.InfeasibleForBothGDVandEV, new List<VehicleSpecificRouteOptimizationOutcome>() { vsroo_GDV, vsroo_AFV });
            else if (vsroo_GDV.Status == VehicleSpecificRouteOptimizationStatus.Optimized)
            {
                if (vsroo_AFV.Status == VehicleSpecificRouteOptimizationStatus.Infeasible)
                    return new RouteOptimizationOutcome(RouteOptimizationStatus.OptimizedForGDVButInfeasibleForEV, new List<VehicleSpecificRouteOptimizationOutcome>() { vsroo_GDV, vsroo_AFV });
                else if (vsroo_AFV.Status == VehicleSpecificRouteOptimizationStatus.Optimized)
                    return new RouteOptimizationOutcome(RouteOptimizationStatus.OptimizedForBothGDVandEV, new List<VehicleSpecificRouteOptimizationOutcome>() { vsroo_GDV, vsroo_AFV });
                else
                    throw new Exception("The TSPsolverEV.SolutionStatus is neither infeasible nor optimal for the AFV");
            }
            else
                throw new Exception("The TSPsolverEV.SolutionStatus is neither infeasible nor optimal for the GDV");
        }
        RouteOptimizationOutcome SolveNoExploitingGDVs(CustomerSet customerSet)
        {
            VehicleSpecificRouteOptimizationOutcome vsroo_GDV;
            VehicleSpecificRouteOptimizationOutcome vsroo_AFV;

            List<string> bestRoute = new List<string>();
            RouteOptimizationOutcome outcome = new RouteOptimizationOutcome();
            int nCustomers = customerSet.Customers.Count;
            List<string> customers = customerSet.Customers;

            stopwatch = Stopwatch.StartNew();
            AFV_Solver.Solve(customerSet);
            t5AFVSoln = stopwatch.Elapsed.TotalSeconds;
            stopwatch.Reset();

            idealStopAfter = 5;

            if (AFV_Solver.SolutionStatus == XCPlexSolutionStatus.Infeasible)
            {
                vsroo_GDV = new VehicleSpecificRouteOptimizationOutcome(theGDV.Category, AFV_Solver.CPUtime, VehicleSpecificRouteOptimizationStatus.Infeasible);
                vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, AFV_Solver.CPUtime, VehicleSpecificRouteOptimizationStatus.Infeasible);
            }
            else if (AFV_Solver.SolutionStatus == XCPlexSolutionStatus.Optimal)
            {
                vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, AFV_Solver.CPUtime, VehicleSpecificRouteOptimizationStatus.Optimized, AFV_Solver.GetVehicleSpecificRoutes(theAFV.Category).First());
                VehicleSpecificRoute vsr_gdv = new VehicleSpecificRoute(theProblemModel, theGDV, vsroo_AFV.VSOptimizedRoute.ListOfVisitedCustomerSiteIDs);
                vsroo_GDV = new VehicleSpecificRouteOptimizationOutcome(theGDV.Category, AFV_Solver.CPUtime, VehicleSpecificRouteOptimizationStatus.Optimized, vsr_gdv);
                bestRoute = vsroo_AFV.VSOptimizedRoute.ListOfVisitedNonDepotSiteIDs;
                vmt5AFVSoln = vsroo_AFV.VSOptimizedRoute.GetVehicleMilesTraveled();
            }
            else
                throw new Exception("The TSPsolverEV.SolutionStatus is neither infeasible nor optimal for the AFV");

            outcome = GetROO(vsroo_GDV, vsroo_AFV);
            optimizationStatstics = new OptimizationStatistics(nCustomers, outcome, customers, t0GDVSoln, t1CheckAFVfeas = 0.0, t2CheckAFVinfeas = 0.0, t3RefuelingPathInsert = 0.0, t4SwapAndInsert = 0.0, t5AFVSoln, idealStopAfter, vmt3RefuelingPathInsert = 0.0, vmt4SwapAndInsert = 0.0, vmt5AFVSoln, bestRoute);
            return outcome;
        }
        RouteOptimizationOutcome SolveOnlyIdenticalRoutes(CustomerSet customerSet)
        {
            //first solve with gdv
            stopwatch = Stopwatch.StartNew();
            GDV_Solver.Solve(customerSet);
            t0GDVSoln = stopwatch.Elapsed.TotalSeconds;
            stopwatch.Reset();

            VehicleSpecificRouteOptimizationOutcome vsroo_GDV = GetGDVsVSROO();
            VehicleSpecificRouteOptimizationOutcome vsroo_AFV;

            List<string> bestRoute = new List<string>();
            RouteOptimizationOutcome outcome = new RouteOptimizationOutcome();
            int nCustomers = customerSet.Customers.Count;
            List<string> customers = customerSet.Customers;

            if (vsroo_GDV.Status == VehicleSpecificRouteOptimizationStatus.Infeasible) //GDV-infeasible
            {
                vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, t0GDVSoln, VehicleSpecificRouteOptimizationStatus.Infeasible);
                idealStopAfter = 0;
            }
            else if (vsroo_GDV.Status == VehicleSpecificRouteOptimizationStatus.Optimized) //GDV-optimal
            {
                stopwatch = Stopwatch.StartNew();
                VehicleSpecificRoute vsr_GDV = vsroo_GDV.VSOptimizedRoute;
                bool afvFeasOfGDVoptSoln = theProblemModel.CheckAFVFeasibilityOfGDVOptimalRoute(vsr_GDV);
                t1CheckAFVfeas = stopwatch.Elapsed.TotalSeconds;
                stopwatch.Reset();
                if (afvFeasOfGDVoptSoln)
                {
                    VehicleSpecificRoute vsr_AFV = new VehicleSpecificRoute(theProblemModel, theAFV, vsr_GDV.ListOfVisitedNonDepotSiteIDs);
                    vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas), VehicleSpecificRouteOptimizationStatus.Optimized, vsr_AFV);
                    idealStopAfter = 1;
                    bestRoute = vsr_AFV.ListOfVisitedNonDepotSiteIDs;
                }
                else //GDV-optimal route is not feasible for AFV
                {
                    stopwatch = Stopwatch.StartNew();
                    AFVInfOfCustomerSet ProveAFVInfeasibilityOfCS = theProblemModel.ProveAFVInfeasibilityOfCustomerSet(vsr_GDV);
                    t2CheckAFVinfeas = stopwatch.Elapsed.TotalSeconds;
                    stopwatch.Reset();
                    if (ProveAFVInfeasibilityOfCS == AFVInfOfCustomerSet.AFVInfeasibilityOfCSProved)
                    {
                        vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas), VehicleSpecificRouteOptimizationStatus.Infeasible);
                        idealStopAfter = 2;
                    }
                    else
                    {
                        stopwatch = Stopwatch.StartNew();
                        AFV_Solver.Solve(customerSet);
                        t5AFVSoln = stopwatch.Elapsed.TotalSeconds;
                        stopwatch.Reset();
                        idealStopAfter = 5;
                        if (AFV_Solver.SolutionStatus == XCPlexSolutionStatus.Infeasible)
                        {
                            vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, AFV_Solver.CPUtime, VehicleSpecificRouteOptimizationStatus.Infeasible);
                        }
                        else if (AFV_Solver.SolutionStatus == XCPlexSolutionStatus.Optimal)
                        {
                            vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, AFV_Solver.CPUtime, VehicleSpecificRouteOptimizationStatus.Optimized, AFV_Solver.GetVehicleSpecificRoutes(theAFV.Category).First());
                            bestRoute = vsroo_AFV.VSOptimizedRoute.ListOfVisitedNonDepotSiteIDs;
                            vmt5AFVSoln = vsroo_AFV.VSOptimizedRoute.GetVehicleMilesTraveled();
                        }
                        else
                            throw new Exception("The TSPsolverEV.SolutionStatus is neither infeasible nor optimal for the AFV");
                    }
                }
            }
            else
                throw new Exception("The TSPsolverEV.SolutionStatus is neither infeasible nor optimal for the GDV");


            outcome = GetROO(vsroo_GDV, vsroo_AFV);
            optimizationStatstics = new OptimizationStatistics(nCustomers, outcome, customers, t0GDVSoln, t1CheckAFVfeas, t2CheckAFVinfeas, t3RefuelingPathInsert = 0.0, t4SwapAndInsert = 0.0, t5AFVSoln, idealStopAfter, vmt3RefuelingPathInsert = 0.0, vmt4SwapAndInsert = 0.0, vmt5AFVSoln, bestRoute);
            return outcome;
        }
        RouteOptimizationOutcome SolveRefuelingPathInsertedRoutes(CustomerSet customerSet)
        {
            //first solve with gdv
            stopwatch = Stopwatch.StartNew();
            GDV_Solver.Solve(customerSet);
            t0GDVSoln = stopwatch.Elapsed.TotalSeconds;
            stopwatch.Reset();

            VehicleSpecificRouteOptimizationOutcome vsroo_GDV = GetGDVsVSROO();
            VehicleSpecificRouteOptimizationOutcome vsroo_AFV;

            List<string> bestRoute = new List<string>();
            RouteOptimizationOutcome outcome = new RouteOptimizationOutcome();
            int nCustomers = customerSet.Customers.Count;
            List<string> customers = customerSet.Customers;

            if (vsroo_GDV.Status == VehicleSpecificRouteOptimizationStatus.Infeasible) //GDV-infeasible
            {
                vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, t0GDVSoln, VehicleSpecificRouteOptimizationStatus.Infeasible);
                idealStopAfter = 0;
            }
            else if (vsroo_GDV.Status == VehicleSpecificRouteOptimizationStatus.Optimized) //GDV-optimal
            {
                stopwatch = Stopwatch.StartNew();
                VehicleSpecificRoute vsr_GDV = vsroo_GDV.VSOptimizedRoute;
                bool afvFeasOfGDVoptSoln = theProblemModel.CheckAFVFeasibilityOfGDVOptimalRoute(vsr_GDV);
                t1CheckAFVfeas = stopwatch.Elapsed.TotalSeconds;
                stopwatch.Reset();
                if (afvFeasOfGDVoptSoln)
                {
                    VehicleSpecificRoute vsr_AFV = new VehicleSpecificRoute(theProblemModel, theAFV, vsr_GDV.ListOfVisitedNonDepotSiteIDs);
                    vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas), VehicleSpecificRouteOptimizationStatus.Optimized, vsr_AFV);
                    idealStopAfter = 1;
                    bestRoute = vsr_AFV.ListOfVisitedNonDepotSiteIDs;
                }
                else //GDV-optimal route is not feasible for AFV
                {
                    stopwatch = Stopwatch.StartNew();
                    AFVInfOfCustomerSet ProveAFVInfeasibilityOfCS = theProblemModel.ProveAFVInfeasibilityOfCustomerSet(vsr_GDV);
                    t2CheckAFVinfeas = stopwatch.Elapsed.TotalSeconds;
                    stopwatch.Reset();
                    if (ProveAFVInfeasibilityOfCS == AFVInfOfCustomerSet.AFVInfeasibilityOfCSProved)
                    {
                        vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas), VehicleSpecificRouteOptimizationStatus.Infeasible);
                        idealStopAfter = 2;
                    }
                    else
                    {
                        vsroo_AFV = GetVehicleSpecificRouteOptimizationOutcomeByRefuelingPathInsert(vsr_GDV, theProblemModel);                      
                        if (vsroo_AFV.Status==VehicleSpecificRouteOptimizationStatus.Optimized)
                        {
                            idealStopAfter = 3;
                        }
                        else
                        {
                            stopwatch = Stopwatch.StartNew();
                            AFV_Solver.Solve(customerSet);
                            t5AFVSoln = stopwatch.Elapsed.TotalSeconds;
                            stopwatch.Reset();
                            idealStopAfter = 5;
                            if (AFV_Solver.SolutionStatus == XCPlexSolutionStatus.Infeasible)
                            {
                                vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, AFV_Solver.CPUtime, VehicleSpecificRouteOptimizationStatus.Infeasible);
                            }
                            else if (AFV_Solver.SolutionStatus == XCPlexSolutionStatus.Optimal)
                            {
                                vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, AFV_Solver.CPUtime, VehicleSpecificRouteOptimizationStatus.Optimized, AFV_Solver.GetVehicleSpecificRoutes(theAFV.Category).First());
                                bestRoute = vsroo_AFV.VSOptimizedRoute.ListOfVisitedNonDepotSiteIDs;
                                vmt5AFVSoln = vsroo_AFV.VSOptimizedRoute.GetVehicleMilesTraveled();
                            }
                            else
                                throw new Exception("The TSPsolverEV.SolutionStatus is neither infeasible nor optimal for the AFV");
                        }
                    }
                }
            }
            else
                throw new Exception("The TSPsolverEV.SolutionStatus is neither infeasible nor optimal for the GDV");


            outcome = GetROO(vsroo_GDV, vsroo_AFV);
            optimizationStatstics = new OptimizationStatistics(nCustomers, outcome, customers, t0GDVSoln, t1CheckAFVfeas, t2CheckAFVinfeas, t3RefuelingPathInsert, t4SwapAndInsert = 0.0, t5AFVSoln, idealStopAfter, vmt3RefuelingPathInsert, vmt4SwapAndInsert = 0.0, vmt5AFVSoln, bestRoute);
            return outcome;
        }
        RouteOptimizationOutcome SolveRefuelingPathInsertedAndSwappedRoutes(CustomerSet customerSet)
        {
            //first solve with gdv
            stopwatch = Stopwatch.StartNew();
            GDV_Solver.Solve(customerSet);
            t0GDVSoln = stopwatch.Elapsed.TotalSeconds;
            stopwatch.Reset();

            VehicleSpecificRouteOptimizationOutcome vsroo_GDV = GetGDVsVSROO();
            VehicleSpecificRouteOptimizationOutcome vsroo_AFV;

            List<string> bestRoute = new List<string>();
            RouteOptimizationOutcome outcome = new RouteOptimizationOutcome();
            int nCustomers = customerSet.Customers.Count;
            List<string> customers = customerSet.Customers;

            if (vsroo_GDV.Status == VehicleSpecificRouteOptimizationStatus.Infeasible) //GDV-infeasible
            {
                vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, t0GDVSoln, VehicleSpecificRouteOptimizationStatus.Infeasible);
                idealStopAfter = 0;
            }
            else if (vsroo_GDV.Status == VehicleSpecificRouteOptimizationStatus.Optimized) //GDV-optimal
            {
                stopwatch = Stopwatch.StartNew();
                VehicleSpecificRoute vsr_GDV = vsroo_GDV.VSOptimizedRoute;
                bool afvFeasOfGDVoptSoln = theProblemModel.CheckAFVFeasibilityOfGDVOptimalRoute(vsr_GDV);
                t1CheckAFVfeas = stopwatch.Elapsed.TotalSeconds;
                stopwatch.Reset();
                if (afvFeasOfGDVoptSoln)
                {
                    VehicleSpecificRoute vsr_AFV = new VehicleSpecificRoute(theProblemModel, theAFV, vsr_GDV.ListOfVisitedNonDepotSiteIDs);
                    vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas), VehicleSpecificRouteOptimizationStatus.Optimized, vsr_AFV);
                    idealStopAfter = 1;
                    bestRoute = vsr_AFV.ListOfVisitedNonDepotSiteIDs;
                }
                else //GDV-optimal route is not feasible for AFV
                {
                    stopwatch = Stopwatch.StartNew();
                    AFVInfOfCustomerSet ProveAFVInfeasibilityOfCS = theProblemModel.ProveAFVInfeasibilityOfCustomerSet(vsr_GDV);
                    t2CheckAFVinfeas = stopwatch.Elapsed.TotalSeconds;
                    stopwatch.Reset();
                    if (ProveAFVInfeasibilityOfCS == AFVInfOfCustomerSet.AFVInfeasibilityOfCSProved)
                    {
                        vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas), VehicleSpecificRouteOptimizationStatus.Infeasible);
                        idealStopAfter = 2;
                    }
                    else //CS-infeasibility for AFV cannot be proved
                    {
                        vsroo_AFV = GetVehicleSpecificRouteBySwapAndInsertES(vsr_GDV, theProblemModel);
                        if (vsroo_AFV.Status != VehicleSpecificRouteOptimizationStatus.Optimized)
                        {
                            stopwatch = Stopwatch.StartNew();
                            AFV_Solver.Solve(customerSet);
                            t5AFVSoln = stopwatch.Elapsed.TotalSeconds;
                            stopwatch.Reset();
                            idealStopAfter = 5;
                            if (AFV_Solver.SolutionStatus == XCPlexSolutionStatus.Infeasible)
                            {
                                vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, AFV_Solver.CPUtime, VehicleSpecificRouteOptimizationStatus.Infeasible);
                            }
                            else if (AFV_Solver.SolutionStatus == XCPlexSolutionStatus.Optimal)
                            {
                                vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, AFV_Solver.CPUtime, VehicleSpecificRouteOptimizationStatus.Optimized, AFV_Solver.GetVehicleSpecificRoutes(theAFV.Category).First());
                                bestRoute = vsroo_AFV.VSOptimizedRoute.ListOfVisitedNonDepotSiteIDs;
                                vmt5AFVSoln = vsroo_AFV.VSOptimizedRoute.GetVehicleMilesTraveled();
                            }
                            else
                                throw new Exception("The TSPsolverEV.SolutionStatus is neither infeasible nor optimal for the AFV");
                        }
                    }
                }
            }
            else
                throw new Exception("The TSPsolverEV.SolutionStatus is neither infeasible nor optimal for the GDV");


            outcome = GetROO(vsroo_GDV, vsroo_AFV);
            optimizationStatstics = new OptimizationStatistics(nCustomers, outcome, customers, t0GDVSoln, t1CheckAFVfeas, t2CheckAFVinfeas, t3RefuelingPathInsert, t4SwapAndInsert, t5AFVSoln, idealStopAfter, vmt3RefuelingPathInsert, vmt4SwapAndInsert, vmt5AFVSoln, bestRoute);
            return outcome;
        }
        RouteOptimizationOutcome SolveDataCollection(CustomerSet customerSet, bool PreserveCustomerVisitSequence, bool feasibleAFVSolnIsEnough, bool performSwap)
        {
            //first solve with gdv
            stopwatch = Stopwatch.StartNew();
            GDV_Solver.Solve(customerSet);
            t0GDVSoln = stopwatch.Elapsed.TotalSeconds;
            stopwatch.Reset();

            VehicleSpecificRouteOptimizationOutcome vsroo_GDV = GetGDVsVSROO();
            VehicleSpecificRouteOptimizationOutcome vsroo_AFV;

            List<string> bestRoute = new List<string>();
            RouteOptimizationOutcome outcome = new RouteOptimizationOutcome();
            int nCustomers = customerSet.Customers.Count;
            List<string> customers = customerSet.Customers;

            
            //check solution if infeasible, 
            if (GDV_Solver.SolutionStatus == XCPlexSolutionStatus.Infeasible)
            {
                vsroo_GDV = new VehicleSpecificRouteOptimizationOutcome(theGDV.Category, GDV_Solver.CPUtime, VehicleSpecificRouteOptimizationStatus.Infeasible);




                vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, t0GDVSoln, VehicleSpecificRouteOptimizationStatus.Infeasible);
                outcome = new RouteOptimizationOutcome(RouteOptimizationStatus.InfeasibleForBothGDVandEV, new List<VehicleSpecificRouteOptimizationOutcome>() { vsroo_GDV, vsroo_AFV });
                idealStopAfter = 0;
                optimizationStatstics = new OptimizationStatistics(nCustomers, outcome, customers, t0GDVSoln, t1CheckAFVfeas, t2CheckAFVinfeas, t3RefuelingPathInsert, t4SwapAndInsert, t5AFVSoln, idealStopAfter, vmt3RefuelingPathInsert, vmt4SwapAndInsert, vmt5AFVSoln, bestRoute);
                return outcome;
            }
            //return infeasible roo
            else if (GDV_Solver.SolutionStatus == XCPlexSolutionStatus.Optimal)
            {
                //check afv-feasibility of the gdv-optimal route
                stopwatch = Stopwatch.StartNew();
                VehicleSpecificRoute vsr_GDV = GDV_Solver.GetVehicleSpecificRoutes(VehicleCategories.GDV).First();
                vsroo_GDV = new VehicleSpecificRouteOptimizationOutcome(theGDV.Category, GDV_Solver.CPUtime, VehicleSpecificRouteOptimizationStatus.Optimized, vsr_GDV);
                bool afvFeasOfGDVoptSoln = theProblemModel.CheckAFVFeasibilityOfGDVOptimalRoute(vsr_GDV);
                t1CheckAFVfeas = stopwatch.Elapsed.TotalSeconds;
                if (afvFeasOfGDVoptSoln)
                {
                    idealStopAfter = 1;
                    VehicleSpecificRoute vsr_AFV = new VehicleSpecificRoute(theProblemModel, theAFV, vsr_GDV.ListOfVisitedNonDepotSiteIDs);
                    bestRoute = vsr_AFV.ListOfVisitedNonDepotSiteIDs;
                    vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas), VehicleSpecificRouteOptimizationStatus.Optimized, vsr_AFV);
                    outcome = new RouteOptimizationOutcome(RouteOptimizationStatus.OptimizedForBothGDVandEV, new List<VehicleSpecificRouteOptimizationOutcome>() { vsroo_GDV, vsroo_AFV });
                    optimizationStatstics = new OptimizationStatistics(nCustomers, outcome, customers, t0GDVSoln, t1CheckAFVfeas, t2CheckAFVinfeas, t3RefuelingPathInsert, t4SwapAndInsert, t5AFVSoln, idealStopAfter, vmt3RefuelingPathInsert, vmt4SwapAndInsert, vmt5AFVSoln, bestRoute);
                    return outcome;
                }
                else //GDV-optimal route is not feasible for AFV
                {
                    stopwatch = Stopwatch.StartNew();
                    AFVInfOfCustomerSet ProveAFVInfeasibilityOfCS = theProblemModel.ProveAFVInfeasibilityOfCustomerSet(vsr_GDV);
                    t2CheckAFVinfeas = stopwatch.Elapsed.TotalSeconds;
                    if (ProveAFVInfeasibilityOfCS == AFVInfOfCustomerSet.AFVInfeasibilityOfCSProved)
                    {
                        idealStopAfter = 2;
                        vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas), VehicleSpecificRouteOptimizationStatus.Infeasible);
                        outcome = new RouteOptimizationOutcome(RouteOptimizationStatus.OptimizedForGDVButInfeasibleForEV, new List<VehicleSpecificRouteOptimizationOutcome>() { vsroo_GDV, vsroo_AFV });
                        optimizationStatstics = new OptimizationStatistics(nCustomers, outcome, customers, t0GDVSoln, t1CheckAFVfeas, t2CheckAFVinfeas, t3RefuelingPathInsert, t4SwapAndInsert, t5AFVSoln, idealStopAfter, vmt3RefuelingPathInsert, vmt4SwapAndInsert, vmt5AFVSoln, bestRoute);
                        return outcome;
                    }
                    else // AFV-infeasibility of the customer set cannot be proved, yet :)
                    {
                        if (performSwap)
                        {
                            vsroo_AFV = GetVehicleSpecificRouteBySwapAndInsertES(vsr_GDV, theProblemModel);
                            if (vsroo_AFV.Status == VehicleSpecificRouteOptimizationStatus.Optimized)
                            {
                                stopwatch = Stopwatch.StartNew();
                                AFV_Solver.Solve(customerSet, false, vsr_GDV);
                                VehicleSpecificRoute solver_vsr;
                                if (AFV_Solver.SolutionStatus == XCPlexSolutionStatus.Optimal)
                                    solver_vsr = AFV_Solver.GetVehicleSpecificRoutes(theAFV.Category).First();
                                else
                                {
                                    solver_vsr = vsroo_AFV.VSOptimizedRoute;
                                    t5AFVSoln = 999999999;
                                }
                                t5AFVSoln = stopwatch.Elapsed.TotalSeconds;
                                vmt5AFVSoln = solver_vsr.GetVehicleMilesTraveled();
                                if (vmt4SwapAndInsert - vmt5AFVSoln >= 0.00001)
                                {
                                    idealStopAfter = 5;
                                    bestRoute = solver_vsr.ListOfVisitedNonDepotSiteIDs;
                                    outcome = new RouteOptimizationOutcome(RouteOptimizationStatus.OptimizedForBothGDVandEV, new List<VehicleSpecificRouteOptimizationOutcome>() { vsroo_GDV, vsroo_AFV });
                                }
                                else
                                {
                                    vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas + t3RefuelingPathInsert + t4SwapAndInsert + t5AFVSoln), VehicleSpecificRouteOptimizationStatus.Optimized, solver_vsr);
                                    outcome = new RouteOptimizationOutcome(RouteOptimizationStatus.OptimizedForBothGDVandEV, new List<VehicleSpecificRouteOptimizationOutcome>() { vsroo_GDV, vsroo_AFV });
                                }
                                optimizationStatstics = new OptimizationStatistics(nCustomers, outcome, customers, t0GDVSoln, t1CheckAFVfeas, t2CheckAFVinfeas, t3RefuelingPathInsert, t4SwapAndInsert, t5AFVSoln, idealStopAfter, vmt3RefuelingPathInsert, vmt4SwapAndInsert, vmt5AFVSoln, bestRoute);
                                return outcome;
                            }
                            else
                            {
                                stopwatch = Stopwatch.StartNew();
                                AFV_Solver.Solve(customerSet, false, vsr_GDV);
                                t5AFVSoln = stopwatch.Elapsed.TotalSeconds;

                                if (AFV_Solver.SolutionStatus == XCPlexSolutionStatus.Optimal)
                                {
                                    VehicleSpecificRoute vsr_AFV = AFV_Solver.GetVehicleSpecificRoutes(theAFV.Category).First();
                                    vmt5AFVSoln = vsr_AFV.GetVehicleMilesTraveled();
                                    bestRoute = vsr_AFV.ListOfVisitedNonDepotSiteIDs;
                                    vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas + t3RefuelingPathInsert + t4SwapAndInsert + t5AFVSoln), VehicleSpecificRouteOptimizationStatus.Optimized, vsr_AFV);
                                    idealStopAfter = 5;
                                    outcome = new RouteOptimizationOutcome(RouteOptimizationStatus.OptimizedForBothGDVandEV, new List<VehicleSpecificRouteOptimizationOutcome>() { vsroo_GDV, vsroo_AFV });
                                    optimizationStatstics = new OptimizationStatistics(nCustomers, outcome, customers, t0GDVSoln, t1CheckAFVfeas, t2CheckAFVinfeas, t3RefuelingPathInsert, t4SwapAndInsert, t5AFVSoln, idealStopAfter, vmt3RefuelingPathInsert, vmt4SwapAndInsert, vmt5AFVSoln, bestRoute);
                                    return outcome;
                                }
                                else
                                {
                                    vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas + t3RefuelingPathInsert + t4SwapAndInsert + t5AFVSoln), VehicleSpecificRouteOptimizationStatus.Infeasible);
                                    idealStopAfter = 5;
                                    outcome = new RouteOptimizationOutcome(RouteOptimizationStatus.OptimizedForGDVButInfeasibleForEV, new List<VehicleSpecificRouteOptimizationOutcome>() { vsroo_GDV, vsroo_AFV });
                                    optimizationStatstics = new OptimizationStatistics(nCustomers, outcome, customers, t0GDVSoln, t1CheckAFVfeas, t2CheckAFVinfeas, t3RefuelingPathInsert, t4SwapAndInsert, t5AFVSoln, idealStopAfter, vmt3RefuelingPathInsert, vmt4SwapAndInsert, vmt5AFVSoln, bestRoute);
                                    return outcome;
                                }
                            }
                        }
                        else
                        {
                            stopwatch = Stopwatch.StartNew();
                            AFV_Solver.Solve(customerSet, PreserveCustomerVisitSequence, vsr_GDV);
                            if (AFV_Solver.SolutionStatus == XCPlexSolutionStatus.Optimal)
                            {
                                VehicleSpecificRoute vsr_AFV = AFV_Solver.GetVehicleSpecificRoutes(theAFV.Category).First();
                                t3RefuelingPathInsert = stopwatch.Elapsed.TotalSeconds;
                                vmt3RefuelingPathInsert = vsr_AFV.GetVehicleMilesTraveled();
                                stopwatch = Stopwatch.StartNew();
                                AFV_Solver.Solve(customerSet, false, vsr_GDV);
                                VehicleSpecificRoute unrestricted_vsr_AFV = AFV_Solver.GetVehicleSpecificRoutes(theAFV.Category).First();
                                t5AFVSoln = stopwatch.Elapsed.TotalSeconds;
                                vmt5AFVSoln = unrestricted_vsr_AFV.GetVehicleMilesTraveled();
                                if (vmt3RefuelingPathInsert - vmt5AFVSoln >= 0.00001)
                                {
                                    bestRoute = vsr_AFV.ListOfVisitedNonDepotSiteIDs;
                                    idealStopAfter = 3;
                                    vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas + t3RefuelingPathInsert + t4SwapAndInsert + t5AFVSoln), VehicleSpecificRouteOptimizationStatus.Optimized, vsr_AFV);
                                }
                                else
                                {
                                    bestRoute = unrestricted_vsr_AFV.ListOfVisitedNonDepotSiteIDs;
                                    idealStopAfter = 5;
                                    vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas + t3RefuelingPathInsert + t4SwapAndInsert + t5AFVSoln), VehicleSpecificRouteOptimizationStatus.Optimized, unrestricted_vsr_AFV);
                                }
                                outcome = new RouteOptimizationOutcome(RouteOptimizationStatus.OptimizedForBothGDVandEV, new List<VehicleSpecificRouteOptimizationOutcome>() { vsroo_GDV, vsroo_AFV });
                                optimizationStatstics = new OptimizationStatistics(nCustomers, outcome, customers, t0GDVSoln, t1CheckAFVfeas, t2CheckAFVinfeas, t3RefuelingPathInsert, t4SwapAndInsert, t5AFVSoln, idealStopAfter, vmt3RefuelingPathInsert, vmt4SwapAndInsert, vmt5AFVSoln, bestRoute);
                                return outcome;
                            }
                            else
                            {
                                stopwatch = Stopwatch.StartNew();
                                AFV_Solver.Solve(customerSet, false, vsr_GDV);
                                t5AFVSoln = stopwatch.Elapsed.TotalSeconds;
                                if (AFV_Solver.SolutionStatus == XCPlexSolutionStatus.Optimal)
                                {
                                    VehicleSpecificRoute vsr_AFV = AFV_Solver.GetVehicleSpecificRoutes(theAFV.Category).First();
                                    bestRoute = vsr_AFV.ListOfVisitedNonDepotSiteIDs;
                                    vmt5AFVSoln = vsr_AFV.GetVehicleMilesTraveled();
                                    vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas + t3RefuelingPathInsert + t4SwapAndInsert + t5AFVSoln), VehicleSpecificRouteOptimizationStatus.Optimized, vsr_AFV);
                                    outcome = new RouteOptimizationOutcome(RouteOptimizationStatus.OptimizedForBothGDVandEV, new List<VehicleSpecificRouteOptimizationOutcome>() { vsroo_GDV, vsroo_AFV });
                                }
                                else
                                {
                                    vsroo_AFV = new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas + t3RefuelingPathInsert + t4SwapAndInsert + t5AFVSoln), VehicleSpecificRouteOptimizationStatus.Infeasible);
                                    outcome = new RouteOptimizationOutcome(RouteOptimizationStatus.OptimizedForGDVButInfeasibleForEV, new List<VehicleSpecificRouteOptimizationOutcome>() { vsroo_GDV, vsroo_AFV });
                                }
                                optimizationStatstics = new OptimizationStatistics(nCustomers, outcome, customers, t0GDVSoln, t1CheckAFVfeas, t2CheckAFVinfeas, t3RefuelingPathInsert, t4SwapAndInsert, t5AFVSoln, idealStopAfter, vmt3RefuelingPathInsert, vmt4SwapAndInsert, vmt5AFVSoln, bestRoute);
                                return outcome;
                            }
                        }
                    }
                }
            }
            else
                throw new System.Exception("The TSPsolverEV.SolutionStatus is neither infeasible nor optimal for vehicle category: ");
        }

        VehicleSpecificRouteOptimizationOutcome GetGDVsVSROO()
        {
            if (GDV_Solver.SolutionStatus == XCPlexSolutionStatus.Infeasible)
                return new VehicleSpecificRouteOptimizationOutcome(theGDV.Category, GDV_Solver.CPUtime, VehicleSpecificRouteOptimizationStatus.Infeasible);
            else if (GDV_Solver.SolutionStatus == XCPlexSolutionStatus.Optimal)
                return new VehicleSpecificRouteOptimizationOutcome(theGDV.Category, GDV_Solver.CPUtime, VehicleSpecificRouteOptimizationStatus.Optimized, GDV_Solver.GetVehicleSpecificRoutes(theGDV.Category).First());
            else
                throw new Exception("The TSPsolverEV.SolutionStatus is neither infeasible nor optimal for the GDV");
        }

        VehicleSpecificRouteOptimizationOutcome GetVehicleSpecificRouteBySwapAndInsertES(VehicleSpecificRoute vsr_GDV, EVvsGDV_ProblemModel theProblemModel)
        {
            VehicleSpecificRoute best_vsr_afterInsert = new VehicleSpecificRoute(theProblemModel, theProblemModel.VRD.GetTheVehicleOfCategory(VehicleCategories.EV), vsr_GDV.ListOfVisitedNonDepotSiteIDs);
            int count = 0;
            int onlyInsertCount = 0;
            List<VehicleSpecificRoute> vsr_AFV_list = new List<VehicleSpecificRoute>();
            List<string> sites = new List<string>();
            RefuelingPathList refuelingPaths = new RefuelingPathList();
            sites = vsr_GDV.ListOfVisitedSiteIncludingDepotIDs;
            List<string> tempSites = new List<string>(sites);

            string origin = "";
            string destination = "";
            string cs = "";

            stopwatch = Stopwatch.StartNew();
            for (int j = 1; j < sites.Count - 1; j++)
            {
                for (int i = 1; i < sites.Count; i++)
                {
                    tempSites = new List<string>(sites);
                    origin = sites[i - 1];
                    destination = sites[i];
                    foreach (RefuelingPath rp in theProblemModel.NonDominatedRefuelingPaths)
                    {
                        if (rp.Origin.ID == origin && rp.Destination.ID == destination && rp.GetRefuelingStopIDs().Count > 0)
                        {
                            tempSites.InsertRange(i, rp.GetRefuelingStopIDs());
                            tempSites.RemoveAt(0);
                            tempSites.RemoveAt(tempSites.Count - 1);
                            VehicleSpecificRoute vsr = new VehicleSpecificRoute(theProblemModel, theProblemModel.VRD.GetTheVehicleOfCategory(VehicleCategories.EV), tempSites);
                            if (vsr.Feasible)
                                vsr_AFV_list.Add(vsr);
                        }
                        tempSites = new List<string>(sites);
                    }
                }
                if (count == 0)
                {
                    count++;
                    t3RefuelingPathInsert = stopwatch.Elapsed.TotalSeconds;
                    if (vsr_AFV_list.Count != 0)
                        best_vsr_afterInsert = new VehicleSpecificRoute(vsr_AFV_list.First());
                    double tempObj = Double.MaxValue;
                    foreach (VehicleSpecificRoute route in vsr_AFV_list)
                    {
                        if (route.GetVehicleMilesTraveled() < tempObj)
                        {
                            best_vsr_afterInsert = new VehicleSpecificRoute(route);
                            bestRoute = best_vsr_afterInsert.ListOfVisitedNonDepotSiteIDs;
                            tempObj = route.GetVehicleMilesTraveled();
                        }
                    }
                    onlyInsertCount = vsr_AFV_list.Count;
                    vmt3RefuelingPathInsert = tempObj;
                    stopwatch = Stopwatch.StartNew();
                }             
                if (sites.Count <= 4)
                    break;
                cs = sites[j];
                sites.RemoveAt(j);
                sites.Insert(j + 1, cs);
            }
            double obj = vmt3RefuelingPathInsert;
            VehicleSpecificRoute vsr_AFV = new VehicleSpecificRoute(best_vsr_afterInsert);
            for (int r = onlyInsertCount; r < vsr_AFV_list.Count; r++)
            {
                VehicleSpecificRoute route = vsr_AFV_list[r];
                if (route.GetVehicleMilesTraveled() < obj)
                {
                    vsr_AFV = new VehicleSpecificRoute(route);
                    bestRoute = vsr_AFV.ListOfVisitedNonDepotSiteIDs;
                    obj = route.GetVehicleMilesTraveled();
                }
            }
            if (count != 0)
                t4SwapAndInsert = stopwatch.Elapsed.TotalSeconds;

            if (vsr_AFV.Feasible)
            {
                vmt4SwapAndInsert = vsr_AFV.GetVehicleMilesTraveled();
                if (vmt3RefuelingPathInsert - vmt4SwapAndInsert >= 0.00001)
                    idealStopAfter = 4;
                else
                    idealStopAfter = 3;
                if (vmt3RefuelingPathInsert == double.MaxValue)
                    vmt3RefuelingPathInsert = 0.0;
                return new VehicleSpecificRouteOptimizationOutcome(VehicleCategories.EV, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas + t3RefuelingPathInsert + t4SwapAndInsert), VehicleSpecificRouteOptimizationStatus.Optimized, vsOptimizedRoute: vsr_AFV);
            }
            else
            {
                vmt3RefuelingPathInsert = 0.0;
                return new VehicleSpecificRouteOptimizationOutcome(VehicleCategories.EV, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas + t3RefuelingPathInsert + t4SwapAndInsert), VehicleSpecificRouteOptimizationStatus.Infeasible);
            }
        }

        VehicleSpecificRouteOptimizationOutcome GetVehicleSpecificRouteOptimizationOutcomeByRefuelingPathInsert(VehicleSpecificRoute vsr_GDV, EVvsGDV_ProblemModel theProblemModel)
        {
            VehicleSpecificRoute best_vsr_afterInsert = new VehicleSpecificRoute(theProblemModel, theProblemModel.VRD.GetTheVehicleOfCategory(VehicleCategories.EV), vsr_GDV.ListOfVisitedNonDepotSiteIDs);
            List<VehicleSpecificRoute> feasible_AFV_VSR_list = new List<VehicleSpecificRoute>();
            List<string> sites = new List<string>();
            RefuelingPathList refuelingPaths = new RefuelingPathList();
            sites = vsr_GDV.ListOfVisitedSiteIncludingDepotIDs;
            List<string> tempSites = new List<string>(sites);

            string origin = "";
            string destination = "";

            stopwatch = Stopwatch.StartNew();
            for (int i = 1; i < sites.Count; i++)
            {
                tempSites = new List<string>(sites);
                origin = sites[i - 1];
                destination = sites[i];
                foreach (RefuelingPath rp in theProblemModel.NonDominatedRefuelingPaths)
                {
                    if (rp.Origin.ID == origin && rp.Destination.ID == destination && rp.GetRefuelingStopIDs().Count > 0)
                    {
                        tempSites.InsertRange(i, rp.GetRefuelingStopIDs());
                        tempSites.RemoveAt(0);
                        tempSites.RemoveAt(tempSites.Count - 1);
                        VehicleSpecificRoute vsr = new VehicleSpecificRoute(theProblemModel, theProblemModel.VRD.GetTheVehicleOfCategory(VehicleCategories.EV), tempSites);
                        if (vsr.Feasible)
                            feasible_AFV_VSR_list.Add(vsr);
                    }
                    tempSites = new List<string>(sites);
                }
            }
            if (feasible_AFV_VSR_list.Count != 0)
            {
                best_vsr_afterInsert = new VehicleSpecificRoute(feasible_AFV_VSR_list.First());
                double tempObj = Double.MaxValue;
                foreach (VehicleSpecificRoute route in feasible_AFV_VSR_list)
                {
                    if (route.GetVehicleMilesTraveled() < tempObj)
                    {
                        best_vsr_afterInsert = new VehicleSpecificRoute(route);
                        bestRoute = best_vsr_afterInsert.ListOfVisitedNonDepotSiteIDs;
                        tempObj = route.GetVehicleMilesTraveled();
                    }
                }
                vmt3RefuelingPathInsert = tempObj;
                t3RefuelingPathInsert = stopwatch.Elapsed.TotalSeconds;
                stopwatch.Reset();
                return new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas + t3RefuelingPathInsert), VehicleSpecificRouteOptimizationStatus.Optimized, best_vsr_afterInsert);
            }
            else
            {
                t3RefuelingPathInsert = stopwatch.Elapsed.TotalSeconds;
                stopwatch.Reset();
                return new VehicleSpecificRouteOptimizationOutcome(theAFV.Category, (t0GDVSoln + t1CheckAFVfeas + t2CheckAFVinfeas + t3RefuelingPathInsert), VehicleSpecificRouteOptimizationStatus.Infeasible);
            }

        }
    }
}
